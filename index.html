<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Character.ai Lite [Unofficial]</title>
    <!-- Puter JS SDK -->
    <script src="https://js.puter.com/v2/"></script>
    <style>
        /* 2007 WEB 2.0 SYSTEM - STICK TO CLASSIC UI */
        * { box-sizing: border-box; font-family: Arial, Helvetica, sans-serif; }
        body { background: #FFFFFF; color: #000000; margin: 0; padding: 0; font-size: 11px; height: 100vh; overflow: hidden; }
        
        header { background: #005DAA; padding: 8px 15px; color: #FFFFFF; border-bottom: 3px solid #78B928; display: flex; align-items: center; justify-content: space-between; }
        .logo { font-size: 22px; font-weight: bold; font-style: italic; color: #FFF; text-decoration: none; letter-spacing: -1px; cursor: pointer; }
        .logo span { color: #FFA500; }
        
        nav { background: #F6F9FC; border-bottom: 1px solid #A5C7E7; padding: 5px 15px; display: flex; gap: 15px; }
        nav a { color: #004E98; text-decoration: none; font-weight: bold; font-size: 10px; cursor: pointer; text-transform: uppercase; }
        nav a:hover { text-decoration: underline; }

        .container { display: flex; height: calc(100vh - 85px); }
        .sidebar { width: 200px; border-right: 1px solid #A5C7E7; background: #F1F6FA; padding: 10px; overflow-y: auto; }
        .sidebar-head { font-weight: bold; color: #004E98; margin-bottom: 8px; border-bottom: 1px solid #A5C7E7; font-size: 10px; padding-bottom: 2px; }

        .content { flex: 1; padding: 10px; overflow-y: auto; background: #FFF; position: relative; }
        .card { border: 1px solid #A5C7E7; background: #FFF; margin-bottom: 10px; display: flex; flex-direction: column; }
        .card-head { background: #E9F1F8; border-bottom: 1px solid #A5C7E7; padding: 5px 10px; color: #004E98; font-weight: bold; font-size: 10px; }
        .card-body { padding: 10px; }

        /* AUTH PORTAL */
        #auth-portal { position: fixed; inset: 0; background: #FFF; z-index: 1000; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .auth-box { width: 300px; border: 1px solid #005DAA; padding: 20px; background: #F6F9FC; }
        .auth-box input { width: 100%; border: 1px solid #A5C7E7; padding: 5px; margin-bottom: 10px; font-size: 12px; }
        .warning-text { color: #cc0000; font-size: 9px; margin-top: 10px; line-height: 1.2; font-weight: bold; }

        /* DASHBOARD GRID */
        .char-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; margin-top: 10px; }
        .char-box { border: 1px solid #A5C7E7; padding: 8px; text-align: center; cursor: pointer; background: #F9FBFD; position: relative; }
        .char-box:hover { background: #FFF; border-color: #005DAA; }
        .char-box img { width: 60px; height: 60px; border: 1px solid #CCC; object-fit: cover; margin-bottom: 5px; }
        .char-box b { display: block; color: #004E98; font-size: 11px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .char-box span { font-size: 9px; color: #666; }
        .edit-badge { position: absolute; top: 2px; right: 2px; background: #FFA500; color: #FFF; font-size: 8px; padding: 1px 4px; font-weight: bold; border: 1px solid #CC8400; }

        /* CHAT UI */
        #chat-window { height: 350px; overflow-y: auto; padding: 10px; border: 1px solid #A5C7E7; margin-bottom: 5px; background: #FFF; font-family: 'Times New Roman', serif; font-size: 14px; }
        .msg { margin-bottom: 10px; display: flex; gap: 8px; }
        .msg img { width: 30px; height: 30px; border: 1px solid #A5C7E7; flex-shrink: 0; }
        .msg-content b { display: block; font-size: 10px; text-transform: uppercase; color: #005DAA; }
        .msg.ai b { color: #78B928; }

        .btn { border: 1px solid #005DAA; background: #E9F1F8; color: #004E98; padding: 3px 8px; font-weight: bold; cursor: pointer; font-size: 10px; }
        .btn:hover { background: #005DAA; color: #FFF; }
        .btn-send { background: #78B928; border-color: #4D781A; color: #FFF; padding: 5px 15px; }

        #status-bar { background: #005DAA; color: #FFF; padding: 2px 10px; font-size: 9px; position: fixed; bottom: 0; width: 100%; }
        .screen { display: none; }
        .screen.active { display: block; }
        
        .search-box { width: 100%; border: 1px solid #A5C7E7; padding: 5px; margin-bottom: 10px; }
    </style>
</head>
<body>

<div id="auth-portal">
    <div class="logo" style="color:#005DAA; margin-bottom: 20px;">c<span>.ai</span> <small style="font-size: 10px; color: #666;">Classic</small></div>
    <div class="auth-box">
        <div id="auth-title" style="font-weight:bold; color:#005DAA; margin-bottom:10px;">LOGIN TO SESSION</div>
        <input type="text" id="auth-user" placeholder="Username (3-20 chars)">
        <input type="password" id="auth-pass" placeholder="Password (4+ chars)">
        <div id="auth-toggle-link" style="font-size: 9px; margin-bottom: 10px; cursor:pointer; color: #004E98; text-decoration: underline;" onclick="toggleAuthMode()">No account? Create one</div>
        <button class="btn btn-send" style="width:100%" onclick="handleAuth()">CONTINUE</button>
        <div class="warning-text">
            NOTE: This is a client-side demo. Data is stored in your browser's LocalStorage. GitHub Pages does not have a shared database.
        </div>
    </div>
</div>

<header id="main-header" style="display:none">
    <div class="logo" onclick="showScreen('home')">c<span>.ai</span></div>
    <div style="font-size: 9px; font-weight: bold;">USER: <span id="display-username"></span></div>
</header>

<nav id="main-nav" style="display:none">
    <a onclick="showScreen('home')">Home</a>
    <a onclick="showScreen('chat')">Messenger</a>
    <a onclick="openCreateScreen()">Create</a>
    <a onclick="showScreen('persona')">Personas</a>
    <a onclick="logout()" style="color:#cc0000">Logout</a>
</nav>

<div class="container" id="main-container" style="display:none">
    <div class="sidebar">
        <div class="sidebar-head">RECENT CHATS</div>
        <div id="recent-list"></div>
    </div>

    <div class="content">
        <div id="screen-home" class="screen active">
            <div class="card">
                <div class="card-head">Search Characters</div>
                <div class="card-body">
                    <input type="text" class="search-box" id="global-search" placeholder="Enter name..." oninput="filterHome()">
                </div>
            </div>
            <div class="sidebar-head">PUBLIC CHARACTERS</div>
            <div id="public-char-grid" class="char-grid"></div>
            <div class="sidebar-head" style="margin-top:20px">MY CREATIONS</div>
            <div id="private-char-grid" class="char-grid"></div>
        </div>

        <div id="screen-chat" class="screen">
            <div class="card">
                <div class="card-head" id="chat-header-name">Messenger</div>
                <div id="chat-window"></div>
                <div class="card-body" style="background:#F6F9FC; border-top: 1px solid #A5C7E7;">
                    <textarea id="chat-input" style="width:100%; height:50px; border:1px solid #A5C7E7; margin-bottom:5px;"></textarea>
                    <div style="display:flex; justify-content:space-between">
                        <button class="btn btn-send" onclick="sendMessage()">SEND MESSAGE</button>
                        <button class="btn" onclick="clearCurrentChat()">CLEAR</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="screen-create" class="screen">
            <div class="card">
                <div class="card-head" id="studio-title">Character Studio</div>
                <div class="card-body">
                    <input type="hidden" id="edit-bot-id">
                    <b>Name:</b><br><input type="text" id="bot-name" class="search-box"><br>
                    <b>Greeting:</b><br><input type="text" id="bot-greet" class="search-box"><br>
                    <b>Personality/Definition:</b><br><textarea id="bot-desc" style="width:100%; height:80px; border:1px solid #A5C7E7;"></textarea><br>
                    <b>Visibility:</b><br>
                    <select id="bot-vis" class="search-box">
                        <option value="public">Public (Everyone)</option>
                        <option value="private">Private (Only Me)</option>
                    </select>
                    <b>Profile Picture:</b> <input type="file" id="bot-pfp-file" accept="image/*"><br><br>
                    <button class="btn btn-send" id="finalize-btn" onclick="createBot()">FINALIZE CHARACTER</button>
                </div>
            </div>
        </div>

        <div id="screen-persona" class="screen">
            <div class="card">
                <div class="card-head">Persona Manager <button class="btn" style="float:right" onclick="resetPersonaForm()">+ New</button></div>
                <div class="card-body">
                    <div id="persona-list" style="margin-bottom:15px"></div>
                    <hr border="0" style="border-top:1px dotted #A5C7E7">
                    <div id="persona-form">
                        <b>Persona Name:</b><br><input type="text" id="per-name" class="search-box"><br>
                        <b>Bio:</b><br><textarea id="per-bio" style="width:100%; height:60px; border:1px solid #A5C7E7;"></textarea><br>
                        <b>PFP:</b> <input type="file" id="per-pfp-file" accept="image/*"><br><br>
                        <button class="btn btn-send" onclick="savePersona()">SAVE PERSONA</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="status-bar">
    STATUS: <span id="sys-status">OFFLINE</span> | CLOUD: Puter.js
</div>

<script>
    let currentUser = null;
    let authMode = 'login';
    let currentChatBot = null;
    let isThinking = false;

    const DB = {
        users: JSON.parse(localStorage.getItem('cai_users') || '{}'),
        characters: JSON.parse(localStorage.getItem('cai_chars') || '[]'),
        personas: JSON.parse(localStorage.getItem('cai_pers') || '[]'),
        chats: JSON.parse(localStorage.getItem('cai_history') || '{}')
    };

    function saveDB() {
        localStorage.setItem('cai_users', JSON.stringify(DB.users));
        localStorage.setItem('cai_chars', JSON.stringify(DB.characters));
        localStorage.setItem('cai_pers', JSON.stringify(DB.personas));
        localStorage.setItem('cai_history', JSON.stringify(DB.chats));
    }

    function toggleAuthMode() {
        authMode = (authMode === 'login' ? 'signup' : 'login');
        document.getElementById('auth-title').innerText = authMode === 'login' ? 'LOGIN TO SESSION' : 'CREATE ACCOUNT';
        document.getElementById('auth-toggle-link').innerText = authMode === 'login' ? 'No account? Create one' : 'Already have an account? Login';
    }

    function handleAuth() {
        const u = document.getElementById('auth-user').value.trim();
        const p = document.getElementById('auth-pass').value.trim();
        if (u.length < 3 || p.length < 4) return alert("Credentials too short.");

        if (authMode === 'signup') {
            if (DB.users[u]) return alert("Username taken.");
            DB.users[u] = { password: p };
            saveDB();
            alert("Account created!");
        } else {
            if (!DB.users[u] || DB.users[u].password !== p) return alert("Wrong credentials.");
        }
        currentUser = u;
        loginSuccess();
    }

    function loginSuccess() {
        document.getElementById('auth-portal').style.display = 'none';
        document.getElementById('main-header').style.display = 'flex';
        document.getElementById('main-nav').style.display = 'flex';
        document.getElementById('main-container').style.display = 'flex';
        document.getElementById('display-username').innerText = currentUser;
        document.getElementById('sys-status').innerText = 'PUTER CLOUD ACTIVE';
        renderHome();
        renderPersonas();
    }

    function logout() {
        currentUser = null;
        location.reload();
    }

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('screen-' + id).classList.add('active');
        if (id === 'home') renderHome();
    }

    async function toBase64(file) {
        return new Promise((r) => {
            const reader = new FileReader();
            reader.onload = () => r(reader.result);
            reader.readAsDataURL(file);
        });
    }

    function openCreateScreen() {
        document.getElementById('studio-title').innerText = "Character Studio";
        document.getElementById('finalize-btn').innerText = "FINALIZE CHARACTER";
        document.getElementById('edit-bot-id').value = '';
        document.getElementById('bot-name').value = '';
        document.getElementById('bot-greet').value = '';
        document.getElementById('bot-desc').value = '';
        showScreen('create');
    }

    function editBot(id, event) {
        event.stopPropagation();
        const bot = DB.characters.find(c => c.id == id);
        if (!bot || bot.creator !== currentUser) return alert("Access Denied.");

        document.getElementById('studio-title').innerText = "Edit: " + bot.name;
        document.getElementById('finalize-btn').innerText = "SAVE CHANGES";
        document.getElementById('edit-bot-id').value = bot.id;
        document.getElementById('bot-name').value = bot.name;
        document.getElementById('bot-greet').value = bot.greet;
        document.getElementById('bot-desc').value = bot.desc;
        document.getElementById('bot-vis').value = bot.vis;
        showScreen('create');
    }

    async function createBot() {
        const editId = document.getElementById('edit-bot-id').value;
        const name = document.getElementById('bot-name').value;
        const greet = document.getElementById('bot-greet').value;
        const desc = document.getElementById('bot-desc').value;
        const vis = document.getElementById('bot-vis').value;
        const pfpFile = document.getElementById('bot-pfp-file').files[0];
        
        if (!name) return alert("Name required.");

        if (editId) {
            const idx = DB.characters.findIndex(c => c.id == editId);
            if (DB.characters[idx].creator !== currentUser) return alert("Unauthorized.");
            DB.characters[idx] = {...DB.characters[idx], name, greet, desc, vis};
            if (pfpFile) DB.characters[idx].pfp = await toBase64(pfpFile);
        } else {
            const pfp = pfpFile ? await toBase64(pfpFile) : "https://api.dicebear.com/7.x/identicon/svg?seed=" + name;
            DB.characters.push({ id: Date.now(), creator: currentUser, name, greet, desc, vis, pfp, visitorList: [] });
        }
        saveDB();
        showScreen('home');
    }

    function renderHome() {
        const publicGrid = document.getElementById('public-char-grid');
        const privateGrid = document.getElementById('private-char-grid');
        const recentBox = document.getElementById('recent-list');
        
        publicGrid.innerHTML = ''; privateGrid.innerHTML = ''; recentBox.innerHTML = '';

        DB.characters.forEach(c => {
            const count = (c.visitorList || []).length;
            const isOwner = c.creator === currentUser;
            const html = `
                <div class="char-box" onclick="startChat(${c.id})">
                    ${isOwner ? `<div class="edit-badge" onclick="editBot(${c.id}, event)">EDIT</div>` : ''}
                    <img src="${c.pfp}">
                    <b>${c.name}</b>
                    <span>Visitors: ${count}</span>
                </div>`;
            if (c.vis === 'public') publicGrid.innerHTML += html;
            if (isOwner) privateGrid.innerHTML += html;
        });

        const history = DB.chats[currentUser] || {};
        Object.keys(history).forEach(bid => {
            const bot = DB.characters.find(b => b.id == bid);
            if (bot) recentBox.innerHTML += `<div style="padding:4px; cursor:pointer" onclick="startChat(${bot.id})"><b>${bot.name}</b></div>`;
        });
    }

    function startChat(id) {
        currentChatBot = DB.characters.find(c => c.id == id);
        if (!currentChatBot) return;

        if (!currentChatBot.visitorList) currentChatBot.visitorList = [];
        if (!currentChatBot.visitorList.includes(currentUser)) {
            currentChatBot.visitorList.push(currentUser);
            saveDB();
        }

        showScreen('chat');
        document.getElementById('chat-header-name').innerText = "Chatting with " + currentChatBot.name;
        renderMessages();

        const history = DB.chats[currentUser] || {};
        if (!history[id]) {
            history[id] = [{ role: 'ai', text: currentChatBot.greet }];
            DB.chats[currentUser] = history;
            saveDB();
            renderMessages();
        }
    }

    function renderMessages() {
        const win = document.getElementById('chat-window');
        win.innerHTML = '';
        const history = (DB.chats[currentUser] || {})[currentChatBot.id] || [];
        const activePer = DB.personas.find(p => p.owner === currentUser && p.active);

        history.forEach(m => {
            const name = m.role === 'ai' ? currentChatBot.name : (activePer ? activePer.name : currentUser);
            const pfp = m.role === 'ai' ? currentChatBot.pfp : (activePer ? activePer.pfp : "");
            win.innerHTML += `<div class="msg"><img src="${pfp}"><div class="msg-content"><b>${name}</b>${m.text}</div></div>`;
        });
        win.scrollTop = win.scrollHeight;
    }

    async function sendMessage() {
        const input = document.getElementById('chat-input');
        const text = input.value.trim();
        if (!text || isThinking) return;

        const history = DB.chats[currentUser][currentChatBot.id];
        history.push({ role: 'user', text });
        renderMessages();
        input.value = '';

        isThinking = true;
        document.getElementById('sys-status').innerText = 'AI THINKING...';

        try {
            const activePer = DB.personas.find(p => p.owner === currentUser && p.active);
            const prompt = `Act as ${currentChatBot.name}. Personality: ${currentChatBot.desc}. Talking to ${activePer ? activePer.name : currentUser}. Keep it short. No emojis. Message: ${text}`;
            const res = await puter.ai.chat(prompt);
            history.push({ role: 'ai', text: res.toString() });
            saveDB();
            renderMessages();
        } catch (e) {
            alert("Error connecting to Puter Cloud.");
        } finally {
            isThinking = false;
            document.getElementById('sys-status').innerText = 'PUTER CLOUD ACTIVE';
        }
    }

    function clearCurrentChat() {
        if (!confirm("Clear?")) return;
        DB.chats[currentUser][currentChatBot.id] = [{ role: 'ai', text: currentChatBot.greet }];
        saveDB();
        renderMessages();
    }

    function renderPersonas() {
        const list = document.getElementById('persona-list');
        list.innerHTML = '';
        DB.personas.filter(p => p.owner === currentUser).forEach(p => {
            list.innerHTML += `<div style="margin-bottom:5px; padding:5px; border:1px solid ${p.active ? 'orange':'#ccc'}">${p.name} <button onclick="activatePersona(${p.id})">USE</button></div>`;
        });
    }

    async function savePersona() {
        const n = document.getElementById('per-name').value;
        const b = document.getElementById('per-bio').value;
        if (!n) return;
        const pfpFile = document.getElementById('per-pfp-file').files[0];
        const pfp = pfpFile ? await toBase64(pfpFile) : "";
        DB.personas.push({ id: Date.now(), owner: currentUser, name: n, bio: b, pfp, active: false });
        saveDB();
        renderPersonas();
        resetPersonaForm();
    }

    function activatePersona(id) {
        DB.personas.forEach(p => { if(p.owner === currentUser) p.active = (p.id == id) });
        saveDB();
        renderPersonas();
    }

    function resetPersonaForm() {
        document.getElementById('per-name').value = '';
        document.getElementById('per-bio').value = '';
    }

    function filterHome() {
        const q = document.getElementById('global-search').value.toLowerCase();
        document.querySelectorAll('.char-box').forEach(b => b.style.display = b.innerText.toLowerCase().includes(q) ? 'block' : 'none');
    }

    window.onload = () => { if (typeof puter !== 'undefined') document.getElementById('sys-status').innerText = 'PUTER READY'; };
</script>
</body>
</html>
